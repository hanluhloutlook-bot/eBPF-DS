# 架构问题与改进方案（2026-01-31）

## 1. 架构不合理点与改进
### 1.1 控制平面与数据平面耦合过重
**问题**：控制器直接把“全量策略”写入本节点 eBPF map，导致跨节点规则污染、扩展性差。并且在 K8s API 不可用时会使用占位 IP，规则失真。

**改进**：
- 引入“本节点规则对齐”机制：节点只写入与本节点 Pod 相关的规则。
- 通过定时 reconcile 从全量策略缓存中计算“本节点应下发规则”。
- 只有在设置 `SIMPLIFIED_MODE=1` 时才允许占位 IP 兜底，避免规则失真。

### 1.2 黑名单模型无法满足白名单诉求
**问题**：当前模式为“命中规则才 drop”，无法实现“未在白名单即拒绝”的语义。

**改进**：
- 新增 `policy_mode` map，用于记录需要“白名单强制”的 Pod IP 及方向（入向/出向）。
- eBPF 逻辑：
  - 命中规则 -> 执行 allow/drop。
  - 未命中规则 -> 若该方向处于白名单管控，则默认 drop。

### 1.3 本节点 Pod 变化导致规则漂移
**问题**：Pod 漂移后，规则仍残留在旧节点，且新节点未及时生效。

**改进**：
- 每个守护进程保存“全量策略缓存”。
- 定时获取本节点 Pod 列表，只下发“本节点涉及的规则”。
- 通过 diff 机制自动删除不再需要的旧规则。

### 1.4 同节点流量未经过挂载点
**问题**：同节点 Pod 之间的流量可能不经过主网卡 tc 挂载点。

**改进**：
- `update_map start` 自动将 tc 规则挂载到常见桥接口（`cni0`、`flannel.1`、`docker0`、`cbr0`）。
- 默认遍历 `veth*` 并挂载（无需环境变量），覆盖同节点通信路径。

---

## 2. 业务功能：白名单模式（类似 Cilium）
### 2.1 需求语义
- 对指定负载配置 ingress/egress 白名单。
- 启用白名单后，该负载只能与白名单内对象通信，其余默认拒绝。

### 2.2 实现要点
- `NetworkPolicyRequest` 新增：
  - `policyMode`（整体）
  - `ingressMode` / `egressMode`（可覆盖整体）
- 控制器在 reconcile 时：
  - 白名单模式：下发 allow 规则 + 设置 `policy_mode`。
  - 黑名单模式：下发 drop 规则，不设置 `policy_mode`。

---

## 3. Pod 漂移与规则同步方案
### 3.1 核心思路
每个节点维护“全量策略缓存 + 本节点 Pod 快照”，只写本节点必要规则。

### 3.2 实现步骤
1. Create/Delete 时更新策略缓存。
2. 定时任务拉取本节点 Pod 列表。
3. 计算目标规则集合与当前已下发规则集合的差异。
4. 仅对差异做 add/delete。

---

## 4. 同节点流量控制
### 4.1 解决方案
- `update_map start` 除主网卡外，自动挂载桥接口 tc。
- 默认遍历 `veth*` 并挂载（无需环境变量）。

---

## 5. 代码改动摘要
- eBPF：新增 `policy_mode` map，默认拒绝逻辑。
- update_map：新增 `mode set/del` 命令，自动挂载桥接口与默认 veth。
- 控制器：新增定时 reconcile、白名单策略与本节点过滤。
 - endpoint：新增 `endpoint_rules`（按 ifindex 绑定），支持 endpoint 级规则。

---

## 6. 与业务目标对齐说明
### 6.1 已满足
1) **定期同步 deployment 与本节点规则对齐**：通过定时 reconcile，只下发本节点相关规则，避免冗余。
2) **外部管理接口**：REST 接口可由外部管理端调用完成策略管理。
3) **与 Calico 兼容**：仅挂载 tc，不改写 iptables，避免与 Calico 规则冲突。
4) **动态扩展**：本节点 reconcile + veth 挂载适配集群规模变化。
5) **中文注释**：关键逻辑与变量已补充中文注释。

### 6.2 仍需完善（建议后续迭代）
- **安装/配置/使用手册 + FAQ**：需补充运维与权限说明。
- **规则变更日志**：需增加持久化日志记录与时间戳。

