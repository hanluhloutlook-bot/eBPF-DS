      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: k8s-ebpf-daemonset
        namespace: kube-system
        labels:
          app: k8s-ebpf
          component: network-ebpf
      spec:
        selector:
          matchLabels:
            app: k8s-ebpf
        updateStrategy:
          type: RollingUpdate
          rollingUpdate:
            maxUnavailable: 1
        template:
          metadata:
            labels:
              app: k8s-ebpf
              component: network-ebpf
            annotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "8090"
              prometheus.io/path: "/actuator/prometheus"
          spec:
            hostNetwork: true
            hostPID: true
            dnsPolicy: ClusterFirstWithHostNet

            priorityClassName: system-node-critical

            tolerations:
            - key: node-role.kubernetes.io/master
              effect: NoSchedule
            - key: node-role.kubernetes.io/control-plane
              effect: NoSchedule
            - operator: Exists
              effect: NoSchedule

            nodeSelector:
              kubernetes.io/os: linux

            # If your registry is private, create a secret (e.g. docker-registry)
            # and set its name below (uncomment the line). Example:
            # imagePullSecrets:
            # - name: docker-registry

            containers:
            - name: ebpf-app
              image: k8s-ebpf/k8s-ebpf:1.1.8
              imagePullPolicy: IfNotPresent

              env:
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.podIP
              - name: JAVA_OPTS
                value: "-Xms256m -Xmx512m -XX:+UseG1GC -Dspring.profiles.active=production"
              - name: EBPF_AUTO_START
                value: "true"
              - name: EBPF_INTERFACE
                value: "eth0"

              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "1Gi"
                  cpu: "1"

              ports:
              - name: http
                containerPort: 8090
                protocol: TCP
              - name: metrics
                containerPort: 8081
                protocol: TCP

              livenessProbe:
                httpGet:
                  path: /actuator/health
                  port: 8090
                  scheme: HTTP
                initialDelaySeconds: 60
                periodSeconds: 30
                timeoutSeconds: 10
                failureThreshold: 3

              readinessProbe:
                httpGet:
                  path: /actuator/health
                  port: 8090
                  scheme: HTTP
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5

              volumeMounts:
              - name: sys-fs-bpf
                mountPath: /sys/fs/bpf
              - name: lib-modules
                mountPath: /lib/modules
                readOnly: true
              - name: debugfs
                mountPath: /sys/kernel/debug
              - name: procfs
                mountPath: /proc
              - name: host-root
                mountPath: /host
                readOnly: true
              - name: logs
                mountPath: /var/log/app

              securityContext:
                privileged: true
                allowPrivilegeEscalation: true
                runAsUser: 0
                runAsGroup: 0
                seccompProfile:
                  type: Unconfined
                capabilities:
                  add:
                    - SYS_ADMIN
                    - NET_ADMIN
                    - SYS_PTRACE
                    - BPF
                    - NET_RAW

              lifecycle:
                preStop:
                  exec:
                    command: ["/bin/sh", "-c", "echo 'Shutting down gracefully...'; sleep 10"]

            volumes:
            - name: sys-fs-bpf
              hostPath:
                path: /sys/fs/bpf
                type: Directory
            - name: lib-modules
              hostPath:
                path: /lib/modules
                type: Directory
            - name: debugfs
              hostPath:
                path: /sys/kernel/debug
                type: Directory
            - name: procfs
              hostPath:
                path: /proc
                type: Directory
            - name: host-root
              hostPath:
                path: /
                type: Directory
            - name: logs
              emptyDir: {}

            terminationGracePeriodSeconds: 60